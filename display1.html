<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í†µë¹± 1ë£¨ì  ë””ìŠ¤í”Œë ˆì´</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body { background-color: #1a1a2e; color: white; font-family: 'Noto Sans KR', sans-serif; text-align: center; margin: 0; padding: 0; overflow: hidden; min-height: 100vh; position: relative; -webkit-user-select: none; user-select: none; }

    .audio-gate { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20000; font-size: 6vw; color: white; }
    .audio-gate.hidden { display: none; }
    .start-button { font-size: 8vw; font-weight: 900; background: #ff6b6b; color: white; border: none; padding: 3vh 6vw; border-radius: 25px; margin-top: 4vh; cursor: pointer; animation: pulse 2s infinite; outline: 3px solid transparent; transition: all 0.3s ease; }
    .start-button:focus { outline: 3px solid #ffd700; background: #ff5252; transform: scale(1.05); }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }

    .call-screen { display: block; }
    .call-screen.hidden { display: none; }

    #message { display: none; width: 100%; padding: 2vh 2vw; background: rgba(220,53,69,0.9); z-index: 1000; justify-content: center; gap: 2vw; flex-wrap: wrap; font-size: 4vw; font-weight: 900; color: white; margin-top: 2vh; }
    #message.show { display: flex; }
    .sold-out-item { background: rgba(255,255,255,0.2); padding: 1vh 2vw; border-radius: 12px; border: 2px solid white; }

    #numbers { display: flex; flex-direction: column; align-items: center; margin-top: 4vh; gap: 2vh; min-height: 28vh; perspective: 1000px; }
    .number-row { display: flex; justify-content: center; align-items: center; gap: 1.5vw; width: 100%; flex-wrap: nowrap; }
    .numBox { background: #ffeb3b; color: #1a1a1a; font-family: 'Noto Sans KR', sans-serif; font-size: 10vw; font-weight: 900; padding: 2vh 2vw; border-radius: 25px; min-width: 9vw; min-height: 12vh; display: flex; align-items: center; justify-content: center; flex-shrink: 1; position: relative; transition: font-size 0.3s ease; }
    .numBox.shrink { font-size: 7vw; }
    .numBox.row-count-1{font-size:12vw;min-width:12vw}.numBox.row-count-2{font-size:11vw;min-width:11vw}.numBox.row-count-3{font-size:10vw;min-width:10vw}.numBox.row-count-4{font-size:9vw;min-width:9vw}.numBox.row-count-5{font-size:8vw;min-width:8vw}
    .numBox.shrink.row-count-2{font-size:7.5vw}.numBox.shrink.row-count-3{font-size:7vw}.numBox.shrink.row-count-4{font-size:6.5vw}.numBox.shrink.row-count-5{font-size:6vw}
    .numBox.new-number { animation: newNumberEntry 0.6s ease-out; }
    @keyframes newNumberEntry { 0%{transform:scale(0.8);opacity:0} 100%{transform:scale(1);opacity:1} }

    .fullscreen-call { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg,#ff6b6b,#ff8e53); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; animation: fullscreenPulse 0.5s ease-in-out; }
    .fullscreen-call.active { display: flex; }
    .fullscreen-number { font-size: 50vw; font-weight: 900; color: white; text-shadow: 0 0 50px rgba(0,0,0,0.3); animation: numberBounce 0.6s ease-out; }
    .fullscreen-message { font-size: 8vw; font-weight: 700; color: white; margin-top: 2vh; text-shadow: 0 0 30px rgba(0,0,0,0.3); animation: messageSlideUp 0.8s ease-out 0.2s both; }

    .fullscreen-closed { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg,#8b0000,#dc143c); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; animation: fullscreenPulse 0.5s ease-in-out; }
    .fullscreen-closed.active { display: flex; }
    .closed-title { font-size: 12vw; font-weight: 900; color: white; text-shadow: 0 0 30px rgba(0,0,0,0.3); animation: messageSlideUp 0.8s ease-out 0.2s both; margin-bottom: 4vh; text-align: center; }
    .closed-message { font-size: 6vw; font-weight: 700; color: white; text-shadow: 0 0 30px rgba(0,0,0,0.3); animation: messageSlideUp 0.8s ease-out 0.4s both; text-align: center; line-height: 1.3; }

    .status-indicator { 
      display: none; 
      position: fixed; 
      bottom: 60px; /* ê³µì§€ì‚¬í•­ ë°” ë†’ì´(ì•½ 50~60px)ë§Œí¼ ë„ì›€ */
      left: 0; 
      right: 0; 
      width: 100%; 
      padding: 2.5vh 2vw; 
      background-color: #4CAF50; 
      color: white; 
      font-size: 5vw; 
      font-weight: 900; 
      text-align: center; 
      z-index: 100; 
      box-shadow: 0 -4px 10px rgba(0,0,0,0.3); 
    }
    .status-indicator.show { display: block; }
    .status-indicator.closed { background-color: #dc3545; }

    /* í•˜ë‹¨ ê³µì§€ì‚¬í•­ ë°” ë†’ì´ ê³ ì • */
    #noticeBar {
      position: fixed;
      bottom: 0;
      width: 100%;
      height: 60px; /* ë†’ì´ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì§€ì • */
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 15px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      font-size: 2.2vw;
      font-weight: bold;
      border-top: 3px solid #ffeb3b;
      z-index: 150;
    }

    @keyframes fullscreenPulse{0%{opacity:0;transform:scale(0.9)}100%{opacity:1;transform:scale(1)}}
    @keyframes numberBounce{0%{transform:scale(0.5);opacity:0}60%{transform:scale(1.1)}100%{transform:scale(1);opacity:1}}
    @keyframes messageSlideUp{0%{transform:translateY(50px);opacity:0}100%{transform:translateY(0);opacity:1}}

    .waiting-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a2e; z-index: 2000; overflow: hidden; }
    .waiting-screen.active { display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .slide { display: none; width: 100%; height: 100%; position: relative; animation: slideIn 1s ease-in-out; }
    .slide.active { display: block; }
    @keyframes slideIn{0%{opacity:0}100%{opacity:1}}
    .slide-image { width: 100%; height: 100%; object-fit: cover; display: block; }

    .text-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background-color: rgba(0,0,0,0.85); color: white; padding: 5vh 5vw; border-radius: 20px; font-size: 8vw; font-weight: bold; z-index: 15000; text-align: center; width: 80%; box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 5px solid #ffc107; display: none; animation: popIn 0.5s cubic-bezier(0.175,0.885,0.32,1.275); }
    .text-overlay.active { display: block; }
    @keyframes popIn{0%{transform:translate(-50%,-50%) scale(0.5);opacity:0}100%{transform:translate(-50%,-50%) scale(1);opacity:1}}
  </style>
</head>
<body>
  <div id="audioGate" class="audio-gate">
    <div>ğŸ”Š í†µë¹± 1ë£¨ì  í˜¸ì¶œë²¨ ì‹œìŠ¤í…œ</div>
    <div style="font-size:4vw;margin-top:2vh;">ìŒì„± ì•ˆë‚´ë¥¼ ë“¤ìœ¼ë ¤ë©´ ë¦¬ëª¨ì»¨ í™•ì¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>
    <button id="startAudioBtn" class="start-button">ğŸµ ìŒì„± í™œì„±í™”</button>
  </div>

  <div id="textOverlay" class="text-overlay"></div>

  <div id="callScreen" class="call-screen hidden">
    <div id="message"></div>
    <div id="numbers"></div>
    <div id="statusIndicator" class="status-indicator"></div>
    <div id="noticeBar" style="position:fixed;bottom:0;width:100%;padding:15px;background:rgba(0,0,0,0.7);color:#fff;font-size:2.5vw;font-weight:bold;text-align:center;border-top:3px solid #ffeb3b;z-index:150;">
      ìŒì‹ì¤€ë¹„ ìˆœì„œì— ë”°ë¼ ë’· ë²ˆí˜¸ê°€ ë¨¼ì € ë°›ìœ¼ì‹¤ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì–‘í•´ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
    </div>
  </div>

  <div id="fullscreenCall" class="fullscreen-call">
    <div id="fullscreenNumber" class="fullscreen-number"></div>
    <div id="fullscreenMessage" class="fullscreen-message"></div>
  </div>

  <div id="fullscreenClosed" class="fullscreen-closed">
    <div class="closed-title">ì¬ê³  ì†Œì§„</div>
    <div class="closed-message">ê¸ˆì¼ ì¬ê³ ì†Œì§„ìœ¼ë¡œ ì¸í•´<br>ë§ˆê°í•©ë‹ˆë‹¤.<br><br>ëŒ€ë‹¨íˆ ì£„ì†¡í•©ë‹ˆë‹¤.</div>
  </div>

  <div id="waitingScreen" class="waiting-screen active">
    <div class="slide active" id="slide1">
      <img src="slide1.jpg" alt="í†µë¹± 1ë£¨ì  ë¸Œëœë”©" class="slide-image">
    </div>
  </div>

  <script>
    let ws, reconnectTimer = null, fullscreenTimer = null, textOverlayTimer = null;
    let audioEnabled = false, isClosedForDay = false, currentMode = 'WAITING';
    let savedStatusText = "";
    const STORE_CODE = '1ru';

    // === ì˜¤ë””ì˜¤ ë§¤ë‹ˆì € (AndroidTV í˜¸í™˜, ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ëˆ„ì  ìˆ˜ì •) ===
    class AudioManager {
      constructor() {
        this.cachedAudio = null; this.hasUserInteraction = false; this.queue = []; this.playing = false;
        const ua = navigator.userAgent.toLowerCase();
        this.isAndroidTV = ua.includes('android') && (ua.includes('tv') || ua.includes('television'));
      }
      getAudio() {
        if (!this.cachedAudio) {
          this.cachedAudio = new Audio(); this.cachedAudio.src = 'dingdong.mp4';
          this.cachedAudio.preload = 'auto'; this.cachedAudio.volume = 1.0;
          if (this.isAndroidTV) { this.cachedAudio.loop = false; this.cachedAudio.autoplay = false; }
        }
        return this.cachedAudio;
      }
      async addToQueue(n) { if (!this.hasUserInteraction) return; this.queue.push(n); if (!this.playing) this.playNext(); }
      async playNext() {
        if (this.queue.length === 0) { this.playing = false; return; }
        this.playing = true; this.queue.shift();
        try {
          const a = this.getAudio(); a.currentTime = 0;
          await new Promise((res, rej) => {
            a.addEventListener('ended', res, { once: true });
            a.addEventListener('error', rej, { once: true });
            a.play().catch(rej);
          });
        } catch (e) {}
        setTimeout(() => this.playNext(), 100);
      }
      cleanup() { if (this.cachedAudio) { this.cachedAudio.pause(); this.cachedAudio.src = ''; this.cachedAudio = null; } }
    }
    const audioManager = new AudioManager();

    function initializeAudioGate() {
      const gate = document.getElementById('audioGate');
      const btn = document.getElementById('startAudioBtn');
      btn.focus();

      async function activate() {
        audioManager.hasUserInteraction = true; audioEnabled = true;
        try { const t = new Audio(); t.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAAAQElGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA=='; await t.play(); } catch(e){}
        gate.classList.add('hidden');
        if (currentMode === 'WAITING') switchToWaitingMode(); else switchToCallMode();
      }

      btn.addEventListener('click', activate, { once: true });
      btn.addEventListener('keydown', e => { if (e.key === 'Enter' || e.keyCode === 23) { e.preventDefault(); activate(); } });
      document.addEventListener('keydown', function handler(e) {
        if (!audioEnabled && (e.key === 'Enter' || e.keyCode === 23)) { e.preventDefault(); activate(); document.removeEventListener('keydown', handler); }
      });
    }

    // === í™”ë©´ ì „í™˜ ===
    function switchToWaitingMode() {
      if (isClosedForDay) return;
      currentMode = 'WAITING';
      document.getElementById('callScreen').classList.add('hidden');
      document.getElementById('waitingScreen').classList.add('active');
      document.getElementById('fullscreenCall').classList.remove('active');
      if (fullscreenTimer) clearTimeout(fullscreenTimer);
    }
    function switchToCallMode() {
      if (isClosedForDay) return;
      currentMode = 'CALL';
      document.getElementById('waitingScreen').classList.remove('active');
      document.getElementById('callScreen').classList.remove('hidden');
      
      // ê¸°ì¡´ì˜ ë¹„ìš°ëŠ” ì½”ë“œ(si.innerText = '')ë¥¼ ì‚­ì œí•˜ê³  ì €ì¥ëœ ìƒíƒœë¥¼ ì ìš©í•©ë‹ˆë‹¤.
      updateStatusIndicator(savedStatusText); 
    }
    function showClosedScreen() {
      document.getElementById('fullscreenClosed').classList.add('active');
      document.getElementById('callScreen').classList.add('hidden');
      document.getElementById('waitingScreen').classList.remove('active');
      isClosedForDay = true;
    }
    function hideClosedScreen() {
      document.getElementById('fullscreenClosed').classList.remove('active');
      isClosedForDay = false;
      if (currentMode === 'WAITING') switchToWaitingMode(); else switchToCallMode();
    }

    // === ë²ˆí˜¸ í‘œì‹œ (createNumberBox ì¤‘ë³µ ì œê±°) ===
    function updateNumbers(numbers) {
      if (currentMode !== 'CALL') return;
      // ì„œë¹™ ë©”ì‹œì§€ ì œê±°
      const existingServe = document.getElementById('serveUntilMessage');
      if (existingServe) existingServe.remove();
      const container = document.getElementById("numbers");
      container.style.display = 'flex';
      const cur = Array.from(container.querySelectorAll('.numBox')).map(c => c.innerText);
      container.innerHTML = '';

      [numbers.slice(0,5), numbers.slice(5,10)].forEach(rowNums => {
        if (rowNums.length > 0) {
          const row = document.createElement("div"); row.className = "number-row";
          const cls = `row-count-${rowNums.length}`;
          rowNums.forEach(num => {
            const box = document.createElement("div"); box.className = `numBox ${cls}`; box.innerText = num;
            if (!cur.includes(num.toString())) box.classList.add('new-number');
            row.appendChild(box);
          });
          container.appendChild(row);
        }
      });
      const hasMenu = document.getElementById('message').classList.contains('show');
      const hasStatus = document.getElementById('statusIndicator').classList.contains('show');
      adjustNumberSize(hasMenu || hasStatus);
    }
    function adjustNumberSize(shrink) {
      document.querySelectorAll('.numBox').forEach(b => { if(shrink) b.classList.add('shrink'); else b.classList.remove('shrink'); });
    }

    // === í’€ìŠ¤í¬ë¦° í˜¸ì¶œ ===
    function showFullscreenCall(number) {
      if (isClosedForDay) return;
      document.getElementById('fullscreenNumber').textContent = number;
      document.getElementById('fullscreenMessage').textContent = `${number}ë²ˆ ì†ë‹˜ ì£¼ë¬¸ ë‚˜ì™”ìŠµë‹ˆë‹¤!`;
      document.getElementById('fullscreenCall').classList.add('active');
      setTimeout(() => audioManager.addToQueue(number), 100);
      if (fullscreenTimer) clearTimeout(fullscreenTimer);
      fullscreenTimer = setTimeout(() => document.getElementById('fullscreenCall').classList.remove('active'), 5000);
    }
    function showFullscreenCallSequence(numbers) {
      if (isClosedForDay || !Array.isArray(numbers) || !numbers.length) return;
      let i = 0;
      if (fullscreenTimer) { clearTimeout(fullscreenTimer); fullscreenTimer = null; }
      (function next() {
        if (i >= numbers.length) return;
        const n = numbers[i];
        document.getElementById('fullscreenNumber').textContent = n;
        document.getElementById('fullscreenMessage').textContent = `${n}ë²ˆ ì†ë‹˜ ì£¼ë¬¸ ë‚˜ì™”ìŠµë‹ˆë‹¤!`;
        document.getElementById('fullscreenCall').classList.add('active');
        setTimeout(() => audioManager.addToQueue(n), 100);
        i++;
        setTimeout(() => { if (i < numbers.length) next(); else setTimeout(() => document.getElementById('fullscreenCall').classList.remove('active'), 3000); }, 3000);
      })();
    }

    // === ì„œë¹™ ë©”ì‹œì§€ (1ë£¨ì  ì „ìš©) ===
    function showServeUntilMessage(message, number) {
      if (isClosedForDay) return;
      const container = document.getElementById("numbers");
      container.style.display = 'none';
      const existing = document.getElementById('serveUntilMessage');
      if (existing) existing.remove();

      const msgBox = document.createElement("div");
      msgBox.id = 'serveUntilMessage';
      msgBox.style.cssText = 'background:#4CAF50;color:white;font-family:"Noto Sans KR",sans-serif;font-size:8vw;font-weight:900;padding:4vh 5vw;border-radius:25px;display:flex;align-items:center;justify-content:center;animation:newNumberEntry 0.6s ease-out;text-align:center;line-height:1.2;min-height:20vh;margin:0 auto;max-width:80vw;margin-top:4vh;';
      msgBox.innerText = message;
      container.parentNode.insertBefore(msgBox, container);
      setTimeout(() => audioManager.addToQueue(number), 100);
    }

    // === ìƒíƒœ í‘œì‹œ ===
    function updateStatusIndicator(text) {
      // ëª¨ë“œì™€ ìƒê´€ì—†ì´ ì¼ë‹¨ í…ìŠ¤íŠ¸ë¥¼ ì €ì¥í•´ë‘¡ë‹ˆë‹¤.
      savedStatusText = text || ""; 
      
      // í˜„ì¬ í˜¸ì¶œ í™”ë©´ì´ ì•„ë‹ˆê±°ë‚˜ ë§ˆê° ìƒíƒœë©´ í™”ë©´ì— ê·¸ë¦¬ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤.
      if (currentMode !== 'CALL' || isClosedForDay) return;
      
      const si = document.getElementById('statusIndicator');
      if (savedStatusText && savedStatusText.trim()) {
        si.innerText = savedStatusText;
        si.classList.add('show');
        adjustNumberSize(true);
      } else {
        si.innerText = '';
        si.classList.remove('show');
        adjustNumberSize(false);
      }
      
      // ë§ˆê° ìƒ‰ìƒ ì²˜ë¦¬
      if (savedStatusText.includes('ì¬ê³ ì†Œì§„') || savedStatusText.includes('ë§ˆê°')) {
        si.classList.add('closed');
      } else {
        si.classList.remove('closed');
      }
    }
    function updateSoldOutMenus(menus) {
      const mb = document.getElementById('message');
      if (menus && menus.length > 0) {
        mb.innerHTML = '';
        menus.forEach(m => { const d = document.createElement('div'); d.className = 'sold-out-item'; d.innerText = `ğŸš« ${m} í’ˆì ˆ`; mb.appendChild(d); });
        mb.classList.add('show');
        if (currentMode === 'CALL') adjustNumberSize(true);
      } else { mb.classList.remove('show'); if (currentMode === 'CALL') adjustNumberSize(false); }
    }
    function showTextOverlay(text, duration) {
      const ov = document.getElementById('textOverlay');
      if (!text || !text.trim()) { ov.classList.remove('active'); return; }
      ov.innerText = text; ov.classList.add('active');
      if (textOverlayTimer) clearTimeout(textOverlayTimer);
      if (duration < 90000) textOverlayTimer = setTimeout(() => ov.classList.remove('active'), duration);
    }

    // === WebSocket ===
    function connectWebSocket() {
      if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}`);

      ws.onopen = () => { ws.send(`DISPLAY:${STORE_CODE}`); };
      ws.onclose = () => { reconnectTimer = setTimeout(connectWebSocket, 3000); };
      ws.onerror = (err) => console.error(`âš ï¸ ${STORE_CODE} ì—ëŸ¬`, err);

      ws.onmessage = (event) => {
        let data; try { data = JSON.parse(event.data); } catch(e) { return; }

        if (data.type === "PING") { try { ws.send(JSON.stringify({type:'PONG'})); } catch(e){} return; }

        // ëª¨ë“œ ì „í™˜ (í•­ìƒ)
        if (data.type === "MODE") {
          if (data.mode === "WAITING") switchToWaitingMode();
          else if (data.mode === "CALL") switchToCallMode();
          return;
        }

        // ëª¨ë“  ëª¨ë“œì—ì„œ ì²˜ë¦¬
        if (data.type === "MENU_UPDATE") updateSoldOutMenus(data.soldOutMenus);
        if (data.type === "MSG_DISPLAY") showTextOverlay(data.text, data.duration);
        if (data.type === "MSG") {
          const t = data.text || "";
          if (t.includes('ì¬ê³ ì†Œì§„') && t.includes('ë§ˆê°')) showClosedScreen();
          else if (t === 'ì•ˆë…•í•˜ì„¸ìš”! í†µë¹± ì…ë‹ˆë‹¤' && isClosedForDay) hideClosedScreen();
        }

        // CALL ëª¨ë“œ ì „ìš©
        if (currentMode === 'CALL') {
          if (data.type === "CALL" && Array.isArray(data.list)) {
            updateNumbers(data.list);
            if (data.calledNumbers && Array.isArray(data.calledNumbers)) showFullscreenCallSequence(data.calledNumbers);
            else if (data.calledNumber) showFullscreenCall(data.calledNumber);
            else if (data.list.length > 0) showFullscreenCall(data.list[data.list.length - 1]);
          }
          else if (data.type === "SERVE_UNTIL") showServeUntilMessage(data.text, data.number);
          else if (data.type === "AUDIO") {
            if (!audioManager.hasUserInteraction) return;
            const files = {'monitor':'voice/monitor.mp3','noodle':'voice/noodle.mp3','pork':'voice/pork.mp3'};
            if (files[data.audioType]) { const a = new Audio(files[data.audioType]); a.volume = 1.0; a.play().catch(()=>{}); }
          }
          else if (data.type === "STATUS") updateStatusIndicator(data.text);
        }
      };
    }

    document.addEventListener('DOMContentLoaded', () => { initializeAudioGate(); connectWebSocket(); switchToWaitingMode(); });
    window.addEventListener('beforeunload', () => { if(ws) ws.close(); if(reconnectTimer) clearTimeout(reconnectTimer); if(fullscreenTimer) clearTimeout(fullscreenTimer); audioManager.cleanup(); });
  </script>
</body>
</html>