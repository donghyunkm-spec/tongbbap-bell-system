<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>í†µë¹± 3ë£¨ì  í˜¸ì¶œ ì‹œìŠ¤í…œ</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 1vh 2vw;
      margin: 0;
      background-color: #fff;
      color: #333;
      height: 100vh;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
    }

    .header {
      text-align: center;
      font-size: 6vw;
      font-weight: bold;
      color: #e91e63;
      margin-bottom: 1vh;
    }

    button, input {
      font-size: 4.5vw;
      padding: 1.2vh 0;
      margin: 0.3vh 0;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      box-sizing: border-box;
    }

    button {
      width: 100%;
    }

    .btn-orange {
      background-color: orange;
      color: white;
    }

    .btn-gray {
      background-color: #ccc;
      color: #333;
    }

    .btn-red {
      background-color: #ff4444;
      color: white;
    }

    .btn-dark-red {
      background-color: #8b0000;
      color: white;
      margin-top: 2vh;
      padding: 2vh 0;
    }

    .btn-green {
      background-color: #28a745;
      color: white;
      margin-top: 1vh;
      padding: 1.5vh 0;
    }

    .btn-blue {
      background-color: #007bff;
      color: white;
      margin-top: 1vh;
      padding: 1.5vh 0;
    }

    /* í˜¸ì¶œ ë²„íŠ¼ í¬ê¸° í‚¤ìš°ê¸° */
    .btn-call {
      font-size: 6vw !important;
      padding: 2vh 0 !important;
      margin: 1vh 0 !important;
    }

    .row {
      display: flex;
      gap: 1.5vw;
      align-items: center;
      width: 100%;
    }

    /* 3ê°œ ë²„íŠ¼ì„ 1/3ì”© ë‚˜ëˆ„ëŠ” ìŠ¤íƒ€ì¼ */
    .row-three-buttons {
      display: flex;
      gap: 1vw;
      align-items: center;
      width: 100%;
      margin-top: 1vh;
    }

    .btn-third {
      flex: 1;
      font-size: 3.5vw !important;
      padding: 1.5vh 0.5vw !important;
      margin: 0 !important;
    }

    .input-short {
      width: 22%;
      font-size: 4.5vw;
      text-align: center;
      border: 2px solid #ccc;
    }

    .btn-flex {
      flex: 1;
    }

    .btn-half {
      flex: 1;
    }

    #status {
      text-align: center;
      font-size: 5.5vw;
      color: #ff0000;
      font-weight: bold;
      margin: 1vh 0;
      padding: 1vh 2vw;
      min-height: 4vh;
      flex-shrink: 0;
      background-color: #ffe6e6;
      border-radius: 8px;
      border: 2px solid #ff6666;
    }

    #displayStatus {
      text-align: center;
      font-size: 4vw;
      font-weight: bold;
      min-height: 3vh;
      flex-shrink: 0;
      border-radius: 8px;
      padding: 0.5vh 1vw;
      margin-bottom: 0.5vh;
    }

    .status-connected {
      background-color: #d4edda;
      color: #155724;
    }

    .status-disconnected {
      background-color: #f8d7da;
      color: #721c24;
    }

    .status-reconnecting {
      background-color: #fff3cd;
      color: #856404;
    }

    #currentNumbers {
      background-color: #f0f0f0;
      padding: 1.5vh 2.5vw;
      border-radius: 6px;
      margin: 0.5vh 0;
      font-size: 5.5vw; /* ë” í° í°íŠ¸ ì‚¬ì´ì¦ˆ */
      text-align: center;
      min-height: 4vh; /* ë” í° ë†’ì´ */
      flex-shrink: 0;
      font-weight: bold; /* êµµê²Œ í‘œì‹œ */
      border: 3px solid #ddd; /* ë” êµµì€ í…Œë‘ë¦¬ */
    }

    .content-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.5vh;
      overflow-y: auto;
    }

    #connectionInfo {
      font-size: 3vw;
      text-align: center;
      color: #666;
      margin-bottom: 0.5vh;
    }

    .pulse {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* PWA ëŠë‚Œì„ ìœ„í•œ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
    .offline-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: #dc3545;
      color: white;
      text-align: center;
      padding: 0.5vh;
      font-size: 3.5vw;
      z-index: 1000;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
    }

    .offline-indicator.show {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div id="offlineIndicator" class="offline-indicator">
    ğŸ”„ ì„œë²„ ì¬ì—°ê²° ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”
  </div>

  <div class="header">ğŸ– í†µë¹± 3ë£¨ì  í˜¸ì¶œë²¨ ğŸœ</div>
  
  <div id="connectionInfo">ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘...</div>
  <div id="displayStatus" class="status-disconnected">ë””ìŠ¤í”Œë ˆì´ ìƒíƒœ í™•ì¸ ì¤‘...</div>

  <div id="currentNumbers">í˜„ì¬ í˜¸ì¶œëœ ë²ˆí˜¸: ì—†ìŒ</div>

  <div class="content-wrapper">
    <!-- í˜¸ì¶œ ë²„íŠ¼ì„ ë‘ ê°œë¡œ ë‚˜ëˆ„ê¸° -->
    <div class="row">
      <input type="number" id="callNumber" class="input-short" placeholder="ë²ˆí˜¸" min="1" max="700" />
      <button class="btn-orange btn-half btn-call" onclick="sendCall()">ğŸ“¢ í˜¸ì¶œ</button>
      <button class="btn-blue btn-half btn-call" onclick="sendCallPlusOne()">ğŸ“¢ í˜¸ì¶œ+1</button>
    </div>

    <div class="row">
      <input type="number" id="sequenceNumber" class="input-short" placeholder="ëë²ˆí˜¸" min="5" max="700" />
      <button class="btn-orange btn-flex" onclick="sendSequenceCall()">ğŸ“¢ ìµœê·¼ 5ê°œ í˜¸ì¶œ</button>
    </div>

    <button class="btn-red" onclick="clearAllNumbers()">ğŸ—‘ï¸ ëª¨ë“  í˜¸ì¶œë²ˆí˜¸ ì§€ìš°ê¸°</button>

    <div id="status">3ë£¨ì  í˜¸ì¶œë²¨ ì‹œìŠ¤í…œ ì¤€ë¹„ë¨</div>

    <div class="row">
      <button class="btn-orange btn-flex" onclick="setWaitingMode()">ğŸ“º ëŒ€ê¸°í™”ë©´ ì‹œì‘</button>
      <button class="btn-orange btn-flex" onclick="setCallMode()">ğŸ“¢ í˜¸ì¶œí™”ë©´ ì‹œì‘</button>
    </div>

    <!-- ì¬ê³ ì†Œì§„ ê´€ë ¨ ë²„íŠ¼ë“¤ì„ ë§¨ ë°‘ìœ¼ë¡œ ì´ë™ -->
    <div class="row-three-buttons">
      <button class="btn-orange btn-third" onclick="sendClosedStatusMessage()">âš ï¸ ì¬ê³ ì†Œì§„</button>
      <button class="btn-green btn-third" onclick="sendDefaultStatusMessage()">ğŸ”„ ê¸°ë³¸ìƒíƒœ</button>
    </div>

    <button class="btn-dark-red" onclick="sendFullClosedMessage()">ğŸš« ì¬ê³ ì†Œì§„ ë§ˆê° (ì „ì²´í™”ë©´)</button>
    <button class="btn-green" onclick="sendWelcomeMessage()">ğŸ”„ ê¸°ë³¸ ë©”ì‹œì§€ë¡œ ë³µêµ¬ (ì „ì²´í™”ë©´ ë§ˆê° í•´ì œ)</button>
  </div>

  <audio id="alert" src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCSqW3/LNeCQEJoO+8+KVQQAJT6/h3rNSEwc7iNb94HQ7BQFM1O+9czCZvpyMnf3mgJFyRBFh3+/8JQEBS9XvuiEEAQECAwQFBgcICQoLDA0ODxAREhMUFRYXGBkaGxwdHh8gISIjJCUmJykqKywtLi8wMTIzNDU2Nzg5Ojs8PT4/QEFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaW1xdXl9gYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXp7fH1+f4CBgoOEhYaHiImKi4yNjo+QkZKTlJWWl5iZmpucnZ6foKGio6SlpqeoqaqrrK2ur7CxsrO0tba3uLm6u7y9vr/AwcLDxMXGx8jJysvMzc7P0NHS09TV1tfY2drb3N3e3+Dh4uPk5ebn6Onq6+zt7u/w8fLz9PX29/j5+vv8/f7/AAECAwQFBgcICQoLDA0ODxAREhMUFRYXGBkaGxwdHh8gISIjJCUmJykqKywtLi8wMTIzNDU2Nzg5Ojs8PT4/QEFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaW1xdXl9gYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXp7fH1+f4CBgoOEhYaHiImKi4yNjo+QkZKTlJWWl5iZmpucnZ6foKGio6SlpqeoqaqrrK2ur7CxsrO0tba3uLm6u7y9vr/AwcLDxMXGx8jJysvMzc7P0NHS09TV1tfY2drb3N3e3+Dh4uPk5ebn6Onq6+zt7u/w8fLz9PX29/j5+vv8/f7/" preload="auto"></audio>

  <script>
    // 3ë£¨ì  ë§¤ì¥ ì½”ë“œ
    const STORE_CODE = '3ru';

    // WebSocket ê´€ë¦¬ í´ë˜ìŠ¤
    class WebSocketManager {
      constructor() {
        this.ws = null;
        this.reconnectTimer = null;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 50; // ìµœëŒ€ ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜
        this.reconnectInterval = 300000; // ì¬ì—°ê²° ê°„ê²© (5ë¶„)
        this.heartbeatTimer = null;
        this.heartbeatInterval = 300000; // 2ë¶„ë§ˆë‹¤ ping
        this.lastPongTime = Date.now();
        this.isManualClose = false;
        
        this.initVisibilityHandling();
        this.connect();
      }

      // í˜ì´ì§€ ê°€ì‹œì„± ë³€í™” ì²˜ë¦¬
      initVisibilityHandling() {
        // Page Visibility APIë¡œ ë°±ê·¸ë¼ìš´ë“œ/í¬ê·¸ë¼ìš´ë“œ ê°ì§€
        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'visible') {
            // í¬ê·¸ë¼ìš´ë“œë¡œ ëŒì•„ì™”ì„ ë•Œ
            console.log(`ğŸ“± ${STORE_CODE} ì•±ì´ í¬ê·¸ë¼ìš´ë“œë¡œ ëŒì•„ì˜´`);
            this.handleForeground();
          } else {
            // ë°±ê·¸ë¼ìš´ë“œë¡œ ê°”ì„ ë•Œ
            console.log(`ğŸ“± ${STORE_CODE} ì•±ì´ ë°±ê·¸ë¼ìš´ë“œë¡œ ì´ë™`);
            this.handleBackground();
          }
        });

        // í˜ì´ì§€ í¬ì»¤ìŠ¤/ë¸”ëŸ¬ ì´ë²¤íŠ¸
        window.addEventListener('focus', () => {
          console.log(`ğŸ¯ ${STORE_CODE} í˜ì´ì§€ í¬ì»¤ìŠ¤ ë¨`);
          this.handleForeground();
        });

        window.addEventListener('blur', () => {
          console.log(`ğŸ˜´ ${STORE_CODE} í˜ì´ì§€ ë¸”ëŸ¬ ë¨`);
        });

        // ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ê°ì§€
        window.addEventListener('online', () => {
          console.log(`ğŸŒ ${STORE_CODE} ì¸í„°ë„· ì—°ê²°ë¨`);
          this.handleOnline();
        });

        window.addEventListener('offline', () => {
          console.log(`ğŸ“µ ${STORE_CODE} ì¸í„°ë„· ì—°ê²° ëŠê¹€`);
          this.handleOffline();
        });
      }

      handleForeground() {
        // ì—°ê²° ìƒíƒœ í™•ì¸ ë° ì¬ì—°ê²°
        if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
          console.log(`ğŸ”„ ${STORE_CODE} í¬ê·¸ë¼ìš´ë“œ ë³µê·€ - ì¬ì—°ê²° ì‹œë„`);
          this.reconnect();
        } else {
          // ì—°ê²°ì´ ì‚´ì•„ìˆëŠ”ì§€ í™•ì¸
          this.sendHeartbeat();
        }
      }

      handleBackground() {
        // ë°±ê·¸ë¼ìš´ë“œë¡œ ê°ˆ ë•ŒëŠ” íŠ¹ë³„í•œ ì²˜ë¦¬ ì—†ìŒ
        // ëª¨ë°”ì¼ ë¸Œë¼ìš°ì €ê°€ ì•Œì•„ì„œ ì—°ê²°ì„ ê´€ë¦¬í•¨
      }

      handleOnline() {
        this.hideOfflineIndicator();
        if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
          this.reconnect();
        }
      }

      handleOffline() {
        this.showOfflineIndicator();
        this.stopHeartbeat();
      }

      connect() {
        if (this.reconnectTimer) {
          clearTimeout(this.reconnectTimer);
          this.reconnectTimer = null;
        }

        if (this.ws) {
          this.isManualClose = true;
          this.ws.close();
        }

        const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${location.host}`;
        
        console.log(`ğŸ”— ${STORE_CODE} WebSocket ì—°ê²° ì‹œë„ (${this.reconnectAttempts + 1}/${this.maxReconnectAttempts}):`, wsUrl);
        
        this.updateConnectionInfo('ì—°ê²° ì¤‘...', true);
        this.isManualClose = false;
        
        try {
          this.ws = new WebSocket(wsUrl);
          this.setupWebSocketEvents();
        } catch (error) {
          console.error(`âŒ ${STORE_CODE} WebSocket ìƒì„± ì‹¤íŒ¨:`, error);
          this.scheduleReconnect();
        }
      }

      setupWebSocketEvents() {
        this.ws.onopen = () => {
          console.log(`âœ… ${STORE_CODE} WebSocket ì—°ê²°ë¨`);
          this.reconnectAttempts = 0;
          this.ws.send(`INPUT:${STORE_CODE}`); // ë§¤ì¥ ì½”ë“œ í¬í•¨í•´ì„œ ì „ì†¡
          this.updateConnectionInfo('ì—°ê²°ë¨', false);
          this.hideOfflineIndicator();
          this.startHeartbeat();
          this.lastPongTime = Date.now();
          setStatus(`âœ… ${STORE_CODE} ì„œë²„ ì—°ê²°ë¨`);
        };

        this.ws.onmessage = (event) => {
          this.lastPongTime = Date.now(); // ë©”ì‹œì§€ ë°›ìœ¼ë©´ ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
          
          try {
            const data = JSON.parse(event.data);
            
            // Pong ì‘ë‹µ ì²˜ë¦¬
            if (data.type === 'PONG') {
              console.log(`ğŸ“ ${STORE_CODE} Pong ë°›ìŒ`);
              return;
            }
            
            if (data.type === 'DISPLAY_ON') {
              isDisplayConnected = true;
              displayStatusBox.innerText = `âœ… ${STORE_CODE} ë””ìŠ¤í”Œë ˆì´ ì—°ê²°ë¨`;
              displayStatusBox.className = "status-connected";
            } else if (data.type === 'DISPLAY_OFF') {
              isDisplayConnected = false;
              displayStatusBox.innerText = `âŒ ${STORE_CODE} ë””ìŠ¤í”Œë ˆì´ ì—°ê²° ëŠê¹€`;
              displayStatusBox.className = "status-disconnected";
              playAlert();
            } else if (data.type === 'CALL' && Array.isArray(data.list)) {
              currentNumbers = data.list;
              updateCurrentNumbersDisplay();
            }
          } catch (e) {
            console.log(`${STORE_CODE} ë¹„JSON ë©”ì‹œì§€:`, event.data);
          }
        };

        this.ws.onerror = (error) => {
          console.error(`âŒ ${STORE_CODE} WebSocket ì—ëŸ¬:`, error);
          setStatus(`âŒ ${STORE_CODE} ì„œë²„ ì—°ê²° ì‹¤íŒ¨`);
        };

        this.ws.onclose = (event) => {
          console.log(`âŒ ${STORE_CODE} WebSocket ì—°ê²° ëŠê¹€:`, event.code, event.reason);
          this.stopHeartbeat();
          
          if (!this.isManualClose) {
            setStatus(`âš ï¸ ${STORE_CODE} ì„œë²„ ì—°ê²° ëŠê¹€`);
            this.updateConnectionInfo('ì—°ê²° ëŠê¹€', false);
            this.scheduleReconnect();
          }
        };
      }

      scheduleReconnect() {
        if (this.reconnectAttempts >= this.maxReconnectAttempts) {
          console.error(`âŒ ${STORE_CODE} ìµœëŒ€ ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ (${this.maxReconnectAttempts})`);
          this.updateConnectionInfo('ì—°ê²° ì‹¤íŒ¨ - ìƒˆë¡œê³ ì¹¨ í•„ìš”', false);
          setStatus(`âŒ ${STORE_CODE} ì—°ê²° ì‹¤íŒ¨ - ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”`);
          return;
        }

        // í•­ìƒ 5ë¶„ ê°„ê²©ìœ¼ë¡œ ì¬ì—°ê²°
        const delay = this.reconnectInterval; // 300000ms (5ë¶„)
        
        this.updateConnectionInfo(`${Math.ceil(delay/1000)}ì´ˆ í›„ ì¬ì—°ê²°...`, true);
        this.showOfflineIndicator();
        
        this.reconnectTimer = setTimeout(() => {
          this.reconnectAttempts++;
          this.reconnect();
        }, delay);
      }

      reconnect() {
        console.log(`ğŸ”„ ${STORE_CODE} ì¬ì—°ê²° ì‹œë„`);
        this.connect();
      }

      // í•˜íŠ¸ë¹„íŠ¸ë¡œ ì—°ê²° ìƒíƒœ í™•ì¸
      startHeartbeat() {
        this.stopHeartbeat();
        this.heartbeatTimer = setInterval(() => {
          if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            // ë§ˆì§€ë§‰ pongìœ¼ë¡œë¶€í„° ë„ˆë¬´ ì˜¤ëœ ì‹œê°„ì´ ì§€ë‚¬ìœ¼ë©´ ì¬ì—°ê²°
            if (Date.now() - this.lastPongTime > 240000) { // 4ë¶„ (2ë¶„ í•˜íŠ¸ë¹„íŠ¸ Ã— 2)
              console.warn(`ğŸš¨ ${STORE_CODE} í•˜íŠ¸ë¹„íŠ¸ íƒ€ì„ì•„ì›ƒ - ì¬ì—°ê²°`);
              this.reconnect();
              return;
            }
            
            // Ping ì „ì†¡
            try {
              this.ws.send(JSON.stringify({ type: 'PING' }));
              console.log(`ğŸ“ ${STORE_CODE} Ping ì „ì†¡`);
            } catch (error) {
              console.error(`âŒ ${STORE_CODE} Ping ì „ì†¡ ì‹¤íŒ¨:`, error);
              this.reconnect();
            }
          }
        }, this.heartbeatInterval);
      }

      stopHeartbeat() {
        if (this.heartbeatTimer) {
          clearInterval(this.heartbeatTimer);
          this.heartbeatTimer = null;
        }
      }

      send(message) {
        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
          this.ws.send(message);
          return true;
        } else {
          console.warn(`âš ï¸ ${STORE_CODE} WebSocketì´ ì—°ê²°ë˜ì§€ ì•ŠìŒ - ì¬ì—°ê²° ì‹œë„`);
          setStatus(`âš ï¸ ${STORE_CODE} ì—°ê²° ëŠê¹€ - ì¬ì—°ê²° ì¤‘...`);
          this.reconnect();
          return false;
        }
      }

      updateConnectionInfo(text, isPulse) {
        const info = document.getElementById('connectionInfo');
        info.textContent = `ğŸ”— ${STORE_CODE} ${text}`;
        if (isPulse) {
          info.classList.add('pulse');
        } else {
          info.classList.remove('pulse');
        }
      }

      showOfflineIndicator() {
        const indicator = document.getElementById('offlineIndicator');
        indicator.classList.add('show');
      }

      hideOfflineIndicator() {
        const indicator = document.getElementById('offlineIndicator');
        indicator.classList.remove('show');
      }

      // ì •ë¦¬
      destroy() {
        this.isManualClose = true;
        this.stopHeartbeat();
        if (this.reconnectTimer) {
          clearTimeout(this.reconnectTimer);
        }
        if (this.ws) {
          this.ws.close();
        }
      }
    }

    // ì „ì—­ ë³€ìˆ˜ë“¤
    let wsManager;
    const statusBox = document.getElementById("status");
    const displayStatusBox = document.getElementById("displayStatus");
    const currentNumbersBox = document.getElementById("currentNumbers");
    let currentNumbers = [];
    let isDisplayConnected = false;

    // WebSocket ë§¤ë‹ˆì € ì´ˆê¸°í™”
    wsManager = new WebSocketManager();

    function updateCurrentNumbersDisplay() {
      if (currentNumbers.length === 0) {
        currentNumbersBox.innerText = "í˜„ì¬ í˜¸ì¶œëœ ë²ˆí˜¸: ì—†ìŒ";
      } else {
        currentNumbersBox.innerText = `í˜„ì¬ í˜¸ì¶œëœ ë²ˆí˜¸: ${currentNumbers.join(', ')}`;
      }
    }

    function setStatus(msg) {
      statusBox.innerText = msg;
    }

    function playAlert() {
      const alert = document.getElementById("alert");
      if (alert) {
        alert.currentTime = 0;
        alert.play().catch(() => {});
      }
    }

    function checkDisplayAndNotify() {
      if (!isDisplayConnected) {
        setStatus(`âš ï¸ ${STORE_CODE} ë””ìŠ¤í”Œë ˆì´ ì—°ê²° ëŠê¹€ - í˜¸ì¶œì´ ì „ë‹¬ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤`);
        playAlert();
        return false;
      }
      return true;
    }

    function sendCall() {
      if (!checkDisplayAndNotify()) return;
      
      const callNumberInput = document.getElementById("callNumber");
      const num = parseInt(callNumberInput.value);
      
      // ë²ˆí˜¸ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ì„ ë•Œ ë§ˆì§€ë§‰ ë²ˆí˜¸ í˜¸ì¶œ
      if (isNaN(num) || callNumberInput.value.trim() === '') {
        if (currentNumbers.length > 0) {
          if (wsManager.send('CALL_LAST')) {
            const lastNumber = currentNumbers[currentNumbers.length - 1];
            setStatus(`ğŸ“¢ ${STORE_CODE} ë§ˆì§€ë§‰ ë²ˆí˜¸ ì¬í˜¸ì¶œ: ${lastNumber}ë²ˆ`);
            callNumberInput.value = '';
          }
        } else {
          setStatus(`âš ï¸ í˜¸ì¶œí•  ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤`);
        }
        return;
      }
      
      // ì •ìƒì ì¸ ë²ˆí˜¸ í˜¸ì¶œ
      if (num >= 1 && num <= 700) {
        if (wsManager.send(`CALL:${num}`)) {
          setStatus(`ğŸ“¢ ${STORE_CODE} ${num}ë²ˆ í˜¸ì¶œë¨`);
          callNumberInput.value = '';
        }
      } else {
        setStatus(`âŒ 1~700 ì‚¬ì´ì˜ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”`);
      }
    }

    // ìƒˆë¡œìš´ í˜¸ì¶œ+1 ê¸°ëŠ¥
    function sendCallPlusOne() {
      if (!checkDisplayAndNotify()) return;
      
      if (currentNumbers.length === 0) {
        setStatus(`âš ï¸ í˜„ì¬ í˜¸ì¶œëœ ë²ˆí˜¸ê°€ ì—†ì–´ì„œ +1 í˜¸ì¶œì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤`);
        return;
      }
      
      const lastNumber = Math.max(...currentNumbers);
      const nextNumber = lastNumber + 1;
      
      if (nextNumber <= 700) {
        if (wsManager.send(`CALL_PLUS_ONE:${nextNumber}`)) {
          setStatus(`ğŸ“¢ ${STORE_CODE} í˜¸ì¶œ+1: ${nextNumber}ë²ˆ í˜¸ì¶œë¨`);
        }
      } else {
        setStatus(`âŒ 700ë²ˆì„ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤`);
      }
    }

    function sendSequenceCall() {
      if (!checkDisplayAndNotify()) return;
      
      const targetNum = parseInt(document.getElementById("sequenceNumber").value);
      if (!isNaN(targetNum) && targetNum >= 5 && targetNum <= 700) {
        // ìƒˆë¡œìš´ ë¡œì§: ì…ë ¥í•œ ë²ˆí˜¸ ê¸°ì¤€ìœ¼ë¡œ ìµœê·¼ 5ê°œ ë²ˆí˜¸ ìƒì„±
        const endNumber = targetNum;
        const startNumber = Math.max(1, endNumber - 4); // ìµœì†Œ 1ë²ˆë¶€í„°
        const sequenceNumbers = [];
        
        for (let i = startNumber; i <= endNumber; i++) {
          sequenceNumbers.push(i);
        }
        
        if (wsManager.send(`SEQUENCE_NEW:${sequenceNumbers.join(',')}`)) {
          setStatus(`ğŸ“¢ ${STORE_CODE} ${sequenceNumbers.join(', ')}ë²ˆ ìµœê·¼ 5ê°œ í˜¸ì¶œë¨`);
          document.getElementById("sequenceNumber").value = '';
        }
      } else {
        setStatus(`âŒ 5~700 ì‚¬ì´ì˜ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”`);
      }
    }

    function clearAllNumbers() {
      if (wsManager.send('CLEAR')) {
        setStatus(`ğŸ—‘ï¸ ${STORE_CODE} ëª¨ë“  í˜¸ì¶œë²ˆí˜¸ ì§€ì›Œì§`);
      }
    }

    function sendMessage(text) {
      if (!checkDisplayAndNotify()) return;
      
      if (wsManager.send(`MSG:${text}`)) {
        setStatus(`ğŸ’¬ ${STORE_CODE} ë©”ì‹œì§€ ì „ì†¡: ${text}`);
      }
    }

    // í•˜ë‹¨ ìƒíƒœ í‘œì‹œê¸° ë©”ì‹œì§€ ë³€ê²½ í•¨ìˆ˜ë“¤
    function sendClosedStatusMessage() {
      if (wsManager.send(`STATUS:ì¬ê³ ì†Œì§„ ë§ˆê°ì…ë‹ˆë‹¤. ì£„ì†¡í•©ë‹ˆë‹¤`)) {
        setStatus(`âš ï¸ ${STORE_CODE} ì¬ê³ ì†Œì§„ ë§ˆê° ìƒíƒœë¡œ ë³€ê²½ë¨`);
      }
    }

    function sendDefaultStatusMessage() {
      if (wsManager.send(`STATUS:ê¹€ì¹˜ë§ì´êµ­ìˆ˜ íŒë§¤ ì¤‘ì…ë‹ˆë‹¤`)) {
        setStatus(`ğŸ”„ ${STORE_CODE} ê¸°ë³¸ ìƒíƒœë¡œ ë³µêµ¬ë¨`);
      }
    }

    function sendFullClosedMessage() {
      if (wsManager.send(`MSG:ê¸ˆì¼ ì¬ê³ ì†Œì§„ìœ¼ë¡œ ì¸í•´ ë§ˆê°í•©ë‹ˆë‹¤. ëŒ€ë‹¨íˆ ì£„ì†¡í•©ë‹ˆë‹¤.`)) {
        setStatus(`ğŸš« ${STORE_CODE} ì „ì²´í™”ë©´ ì¬ê³ ì†Œì§„ ë§ˆê° ë©”ì‹œì§€ ì „ì†¡ë¨`);
      }
    }

    function sendWelcomeMessage() {
      if (wsManager.send(`MSG:ì•ˆë…•í•˜ì„¸ìš”! í†µë¹± ì…ë‹ˆë‹¤`)) {
        setStatus(`ğŸ”„ ${STORE_CODE} ê¸°ë³¸ ë©”ì‹œì§€ë¡œ ë³µêµ¬ë¨ (ì „ì²´í™”ë©´ ë§ˆê° í•´ì œ)`);
      }
    }

    function setWaitingMode() {
      if (wsManager.send('MODE:WAITING')) {
        setStatus(`ğŸ“º ${STORE_CODE} ëŒ€ê¸°í™”ë©´ ëª¨ë“œë¡œ ì „í™˜ë¨`);
      }
    }

    function setCallMode() {
      if (wsManager.send('MODE:CALL')) {
        setStatus(`ğŸ“¢ ${STORE_CODE} í˜¸ì¶œí™”ë©´ ëª¨ë“œë¡œ ì „í™˜ë¨`);
      }
    }

    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
      if (wsManager) {
        wsManager.destroy();
      }
    });

    // ì—”í„°í‚¤ë¡œ í˜¸ì¶œ ê¸°ëŠ¥
    document.getElementById('callNumber').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendCall();
      }
    });

    document.getElementById('sequenceNumber').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendSequenceCall();
      }
    });
  </script>
</body>
</html>