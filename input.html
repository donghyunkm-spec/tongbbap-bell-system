<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>í†µë¹± 3ë£¨ì  ê´€ë¦¬ì</title>
  <style>
    :root { --bg: #f0f2f5; --tv: #1a1a2e; --pri: #e91e63; --sec: #007bff; --suc: #28a745; --err: #dc3545; }
    body { font-family: 'Pretendard', sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
    
    .dashboard { background: var(--tv); border-radius: 15px; padding: 12px; color: white; margin-bottom: 10px; border: 2px solid #444; }
    .v-screen { background: #000; border-radius: 8px; padding: 10px; min-height: 80px; border: 1px solid #333; display: flex; flex-direction: column; justify-content: center; }
    .v-text { font-size: 18px; font-weight: 800; color: #0f0; margin-top: 5px; line-height: 1.4; }
    
    .content { flex: 1; overflow-y: auto; }
    .row { display: flex; gap: 8px; margin-bottom: 8px; }
    .section-title { font-size: 13px; font-weight: bold; color: #555; margin: 12px 0 6px 5px; }
    
    button { border: none; border-radius: 10px; font-weight: 800; cursor: pointer; transition: 0.1s; }
    button:active { transform: scale(0.97); }
    button:disabled { background: #ccc !important; color: #888 !important; cursor: not-allowed; }
    
    .input-num { width: 65px; border: 2px solid #ddd; border-radius: 10px; font-size: 20px; text-align: center; }
    .btn-call { flex: 1.2; height: 60px; font-size: 22px; background: linear-gradient(#ff9800, #f44336); color: white; }
    .btn-n { flex: 1; height: 60px; background: var(--sec); color: white; }
    
    .input-text { flex: 1; border: 2px solid #ddd; border-radius: 10px; padding: 10px; font-size: 15px; }
    .btn-action { width: 85px; background: var(--sec); color: white; }
    
    .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
    .btn-menu { height: 45px; background: white; border: 1px solid #ddd; font-size: 12px; }
    .sold-out { background: #ffebee; border-color: var(--err); color: var(--err); text-decoration: line-through; }
    
    .btn-ctrl { height: 45px; flex: 1; background: #eee; font-size: 13px; }
    .btn-blue { background: var(--sec); color: white; }
    .btn-green { background: var(--suc); color: white; }
    .btn-red { background: var(--err); color: white; }
  </style>
</head>
<body>
  <div class="dashboard">
    <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
      <span>ğŸ“º ì‹¤ì‹œê°„ TV ëª¨ë‹ˆí„°ë§ (3ë£¨ì )</span>
      <span id="conn"><span style="color:#e74c3c">â—</span> TV ì—°ê²°ëŠê¹€</span>
    </div>
    <div class="v-screen">
      <div id="v-mode" style="font-size:12px; color:#ffc107; font-weight: bold;">ëª¨ë“œ: ì„œë²„ ì—°ê²° ì¤‘...</div>
      <div id="v-msg" class="v-text">ì—°ê²°ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤.</div>
      <div id="v-list" style="font-size:12px; color:#fff; opacity:0.7; margin-top:5px;">í˜¸ì¶œ ëª©ë¡: ---</div>
    </div>
  </div>

  <div class="content">
    <div class="section-title">ğŸ“¢ ë²ˆí˜¸ í˜¸ì¶œ ì œì–´</div>
    <div class="row">
      <input type="number" id="cNum" class="input-num" placeholder="ë²ˆí˜¸" />
      <button class="btn-call" id="callB" onclick="hCall()">ğŸ“¢ í˜¸ì¶œ</button>
      <button class="btn-n" onclick="hPlus(1)">+1</button>
      <button class="btn-n" onclick="hPlus(3)">+3</button>
      <button class="btn-n" onclick="hPlus(5)">+5</button>
    </div>

    <div class="section-title">ğŸ½ï¸ ì„œë¹™ ì•Œë¦¼ (10ì´ˆê°„ ìƒë‹¨ ë©”ì‹œì§€ ë…¸ì¶œ)</div>
    <div class="row">
      <input type="number" id="sNum" class="input-text" style="flex:0.3" placeholder="ë²ˆí˜¸" />
      <button class="btn-green btn-action" style="flex:1" onclick="hServe()">ë²ˆê¹Œì§€ ë“œë¦½ë‹ˆë‹¤</button>
    </div>

    <div class="section-title">ğŸ“ í•˜ë‹¨ ì „ê´‘íŒ í…ìŠ¤íŠ¸ ê³ ì •</div>
    <div class="row">
      <input type="text" id="mIn" class="input-text" placeholder="ê³ ì •í•  ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
      <button class="btn-blue btn-action" id="sB" onclick="hSendM()">ê³ ì • ì „ì†¡</button>
      <button class="btn-ctrl" style="flex:0.3" onclick="hClearM()">ì§€ìš°ê¸°</button>
    </div>

    <div class="section-title">ğŸš« ì‹¤ì‹œê°„ ë©”ë‰´ í’ˆì ˆ ê´€ë¦¬</div>
    <div class="menu-grid" id="mG">
      <button class="btn-menu" onclick="tMenu('ì†Œì„¸ì§€ë‚˜ìµ¸')">ì†Œì„¸ì§€ë‚˜ìµ¸</button>
      <button class="btn-menu" onclick="tMenu('ë¹„ë¹”ë©´')">ë¹„ë¹”ë©´</button>
      <button class="btn-menu" onclick="tMenu('ê¹€ì¹˜ë§ì´êµ­ìˆ˜')">ê¹€ì¹˜ë§ì´êµ­ìˆ˜</button>
      <button class="btn-menu" onclick="tMenu('ì‚¼ê²¹ì‚´')">ì‚¼ê²¹ì‚´</button>
      <button class="btn-menu" onclick="tMenu('ìš°ë™')">ìš°ë™</button>
      <button class="btn-menu" onclick="tMenu('ì”ì¹˜êµ­ìˆ˜')">ì”ì¹˜êµ­ìˆ˜</button>
    </div>

    <div class="section-title">âš™ï¸ ì‹œìŠ¤í…œ ë° í™”ë©´ ì œì–´</div>
    <div class="row">
      <button class="btn-ctrl" onclick="sMode('WAITING')">ğŸ“º í™ë³´í™”ë©´ ì „í™˜</button>
      <button class="btn-ctrl btn-blue" onclick="sMode('CALL')">ğŸ“¢ í˜¸ì¶œí™”ë©´ ì „í™˜</button>
      <button class="btn-ctrl btn-green" onclick="sDef()">ğŸœ íŒë§¤ì¤‘ ê¸°ë³¸ì„¤ì •</button>
    </div>
    <div class="row">
      <button class="btn-ctrl btn-red" onclick="hReset()">ğŸ§¹ ë²ˆí˜¸ ì „ì²´ ì´ˆê¸°í™”</button>
      <button class="btn-ctrl btn-red" onclick="hFullC()">ğŸš« ì¬ê³ ë§ˆê° ì „ì†¡</button>
      <button class="btn-ctrl btn-green" onclick="hRelease()">ğŸ”„ ë§ˆê° í•´ì œ</button>
    </div>
  </div>

  <script>
    const STORE = '3ru'; 
    let currentStatusText = "";
    let ws; 
    let last = 0; 
    let currentMode = 'WAITING'; 
    let isBusy = false;
    let msgDisplayFixed = false; // ì „ê´‘íŒ ê³ ì • ìƒíƒœ ì¶”ì 
    let monitorTimer = null; // ëª¨ë‹ˆí„°ìš© íƒ€ì´ë¨¸ ì¶”ê°€
    let currentFixedMsg = ""; // ì „ê´‘íŒ/ì„ì‹œ ë©”ì‹œì§€ ì €ì¥ìš© ë³€ìˆ˜ ì¶”ê°€

    function connect() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}`);

      ws.onopen = () => { 
        ws.send(`INPUT:${STORE}`);
      };

      ws.onclose = () => {
        document.getElementById('v-msg').innerText = "ì„œë²„ì™€ ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤. ì¬ì—°ê²° ì¤‘...";
        document.getElementById('v-mode').innerText = "ëª¨ë“œ: ì—°ê²° ëŠê¹€";
        document.getElementById('v-mode').style.color = "#ff4757";
        setTimeout(connect, 3000);
      };

      ws.onmessage = (e) => {
        let d;
        try { d = JSON.parse(e.data); } catch { return; }
        
        // PING ì‘ë‹µ
        if (d.type === 'PING') {
          try { ws.send(JSON.stringify({ type: 'PONG' })); } catch(e) {}
          return;
        }
        
        // TV ì—°ê²° ìƒíƒœ
        if (d.type === 'DISPLAY_ON') {
          document.getElementById('conn').innerHTML = '<span style="color:#2ecc71">â—</span> TV ì—°ê²°ë¨';
        }
        if (d.type === 'DISPLAY_OFF') {
          document.getElementById('conn').innerHTML = '<span style="color:#e74c3c">â—</span> TV ì—°ê²°ëŠê¹€';
        }
        
        // ëª¨ë“œ ì—…ë°ì´íŠ¸
        if (d.type === 'MODE') { 
          currentMode = d.mode;
          updateModeUI();
        }
        
        // í˜¸ì¶œ ëª©ë¡ ì—…ë°ì´íŠ¸
        if (d.type === 'CALL') { 
          const list = d.list || []; 
          if (list.length > 0) last = Number(list[list.length - 1]);
          else last = 0;
          document.getElementById('v-list').innerText = `í˜¸ì¶œ ëª©ë¡: ${list.join(', ') || 'ì—†ìŒ'}`;
          // í˜¸ì¶œ ëª©ë¡ì´ ìˆìœ¼ë©´ í˜¸ì¶œí™”ë©´ ëª¨ë“œ í‘œì‹œ ê°±ì‹ 
          if (list.length > 0 && !msgDisplayFixed) {
            updateModeUI();
          }
        }

        // ì „ê´‘íŒ í…ìŠ¤íŠ¸ ê³ ì • ì²˜ë¦¬
        if (d.type === 'MSG_DISPLAY') {
          if (monitorTimer) clearTimeout(monitorTimer);

          if (d.text && d.text.trim()) {
            msgDisplayFixed = true;
            if (d.duration < 90000) {
              currentFixedMsg = `<span style="color:#ff9800">[ì„ì‹œ] ${d.text}</span>`;
              monitorTimer = setTimeout(() => {
                msgDisplayFixed = false;
                currentFixedMsg = "";
                updateModeUI();
              }, d.duration);
            } else {
              currentFixedMsg = `<span style="color:#00c6ff">[ê³ ì •] ${d.text}</span>`;
            }
          } else {
            msgDisplayFixed = false;
            currentFixedMsg = "";
          }
          updateModeUI();
        }

        // STATUS ì²˜ë¦¬ ë¶€ë¶„ ìˆ˜ì •
        if (d.type === 'STATUS') {
          currentStatusText = d.text || "";
          updateModeUI(); // ë¬´ì¡°ê±´ ì—…ë°ì´íŠ¸í•˜ì—¬ ì‹¤ì‹œê°„ ë°˜ì˜
        }
        
        if (d.type === 'MSG') {
          const text = d.text || "";
          if (text.includes('ì¬ê³ ì†Œì§„') || text.includes('ë§ˆê°')) {
            document.getElementById('v-mode').innerText = "ëª¨ë“œ: ğŸš« ì¬ê³  ë§ˆê° í™”ë©´";
            document.getElementById('v-mode').style.color = "#ff4757";
            document.getElementById('v-msg').innerHTML = `<span style="color:#ff4757">${text}</span>`;
          } else if (!msgDisplayFixed) {
            document.getElementById('v-msg').innerText = text;
            updateModeUI();
          }
        }

        // ë©”ë‰´ í’ˆì ˆ ìƒíƒœ ë™ê¸°í™”
        if (d.type === 'MENU_UPDATE') updateMenuUI(d.soldOutMenus);
      };
    }

    function updateModeUI() {
      const modeEl = document.getElementById('v-mode');
      const msgEl = document.getElementById('v-msg');
      modeEl.style.color = "#ffc107";

      // 1. ìƒë‹¨ ëª¨ë“œ í…ìŠ¤íŠ¸ ì„¤ì •
      if (currentMode === 'WAITING') {
        modeEl.innerText = "ëª¨ë“œ: ğŸ“º í™ë³´ í™”ë©´ ë…¸ì¶œ ì¤‘";
      } else {
        modeEl.innerText = "ëª¨ë“œ: ğŸ“¢ í˜¸ì¶œ í™”ë©´ ë…¸ì¶œ ì¤‘";
      }

      // 2. ë©”ì‹œì§€ ì˜ì—­ ë³‘í•© ìƒì„±
      let combinedHtml = "";

      // [ìƒíƒœ] íŒë§¤ì¤‘ ê¸°ë³¸ ì„¤ì • ë©”ì‹œì§€ (ì´ˆë¡ìƒ‰)
      if (currentStatusText) {
        combinedHtml += `<div style="color: #4CAF50; font-size: 14px; margin-bottom: 4px;">â— íŒë§¤ìƒíƒœ: ${currentStatusText}</div>`;
      }

      // [ì „ê´‘íŒ] ê³ ì • ë˜ëŠ” ì„ì‹œ ë©”ì‹œì§€ (í•˜ëŠ˜ìƒ‰/ì£¼í™©ìƒ‰)
      if (msgDisplayFixed && currentFixedMsg) {
        combinedHtml += `<div style="line-height: 1.2;">${currentFixedMsg}</div>`;
      }

      // ë§Œì•½ ì•„ë¬´ ë©”ì‹œì§€ë„ ì—†ë‹¤ë©´ ê¸°ë³¸ ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ
      if (!combinedHtml) {
        combinedHtml = currentMode === 'WAITING' ? "í™ë³´ ì˜ìƒ ë…¸ì¶œ ì¤‘" : "ëŒ€ê¸° ì¤‘...";
      }

      msgEl.innerHTML = combinedHtml;
    }

    function checkPW() { return prompt("ë³´ì•ˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (4ìë¦¬)") === "1234"; }
    
    function ensureCallMode() { if (currentMode !== 'CALL') ws.send('MODE:CALL'); }
    
    function hCall() { 
      const e = document.getElementById('cNum'); 
      if (e.value) { 
        ensureCallMode(); 
        ws.send(`CALL:${e.value}`); 
        e.value = ''; 
      } else if (last > 0) { 
        ensureCallMode(); 
        ws.send('CALL_LAST'); 
      }
    }

    async function hPlus(n) {
      if (isBusy) return; 
      isBusy = true; 
      ensureCallMode();
      const startNum = Number(last);
      for (let i = 1; i <= n; i++) { 
        ws.send(`CALL:${startNum + i}`); 
        await new Promise(r => setTimeout(r, 1500)); 
      }
      isBusy = false;
    }

    function hServe() {
      const e = document.getElementById('sNum'); 
      if (!e.value) return; 
      ensureCallMode();
      ws.send(`MSG_DISPLAY:${e.value}ë²ˆ ì†ë‹˜ê¹Œì§€ ë“œë¦½ë‹ˆë‹¤|10000`); 
      e.value = '';
    }

    function hSendM() { 
      const inputEl = document.getElementById('mIn');
      const val = inputEl.value; 
      if (val) {
        ws.send(`MSG_DISPLAY:${val}|999999`);
        inputEl.disabled = true; // ì…ë ¥ì°½ ë¹„í™œì„±í™”
      }
    }

    function hClearM() { 
      const inputEl = document.getElementById('mIn');
      ws.send(`MSG_DISPLAY: |1`);
      inputEl.value = '';      // ë‚´ìš© ì´ˆê¸°í™”
      inputEl.disabled = false; // ì…ë ¥ì°½ í™œì„±í™”
    }
    
    function sMode(m) { 
      if (m === 'WAITING' && currentMode === 'CALL') { if (!checkPW()) return; }
      ws.send(`MODE:${m}`); 
    }

    function sDef() { 
      const defaultMsg = "ê¹€ì¹˜ë§ì´êµ­ìˆ˜ íŒë§¤ ì¤‘ì…ë‹ˆë‹¤";
      // í˜„ì¬ ë¬¸êµ¬ì™€ ê°™ìœ¼ë©´ ë¹ˆ ê°’ì„ ë³´ë‚´ì„œ í•´ì œ, ë‹¤ë¥´ë©´ ë¬¸êµ¬ ì „ì†¡
      if (currentStatusText === defaultMsg) {
        ws.send(`STATUS: `); 
      } else {
        ws.send(`STATUS:${defaultMsg}`); 
      }
    }
    
    function tMenu(m) { ws.send(`TOGGLE_MENU:${m}`); }

    function updateMenuUI(list) {
      if (!list) return;
      document.querySelectorAll('.btn-menu').forEach(btn => {
        const menuName = btn.getAttribute('onclick').match(/'([^']+)'/)[1];
        if (list.includes(menuName)) {
          btn.classList.add('sold-out');
        } else {
          btn.classList.remove('sold-out');
        }
      });
    }

    function hReset() { if (confirm("í˜¸ì¶œ ëª©ë¡ì„ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) ws.send('CLEAR'); }

    function hFullC() { 
      if (checkPW()) ws.send(`MSG:ê¸ˆì¼ ì¬ê³ ì†Œì§„ìœ¼ë¡œ ì¸í•´ ë§ˆê°í•©ë‹ˆë‹¤. ëŒ€ë‹¨íˆ ì£„ì†¡í•©ë‹ˆë‹¤.`); 
    }

    function hRelease() {
      ws.send('MSG:ì•ˆë…•í•˜ì„¸ìš”! í†µë¹± ì…ë‹ˆë‹¤');
    }

    connect();
  </script>
</body>
</html>